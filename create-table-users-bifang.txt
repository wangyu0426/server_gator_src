CREATE DATABASE bifang;
create table users 
(
	_id serial primary key not null,
	data jsonb
);

create table moods 
(
	_id serial primary key not null,
	user_id int not null,
	lat real not null,  
  	lng real not null,  
	data jsonb
);

CREATE INDEX idx_jsonb_user_info  ON users USING gin (data jsonb_path_ops);
create unique index idx_username on users using btree ( jsonb_extract_path_text(data, 'name'));


CREATE INDEX idx_jsonb_mood  ON moods USING gin (data jsonb_path_ops);
CREATE INDEX idx_jsonb_lat_lng  on moods USING gist(ll_to_earth(lat, lng));  


/*插入记录*/  
INSERT INTO moods(user_id, lat, lng, data) VALUES(1, 40.043945, 116.413668, '{"mood_score": 3, "descr": "not bad"}'::jsonb);  
INSERT INTO moods(user_id, lat, lng, data) VALUES(1, 40.067183, 116.415230, '{"mood_score": 1, "descr": "feel sad"}'::jsonb);  

SELECT * FROM moods where earth_box(ll_to_earth(40.059286,116.418773),1000) @> ll_to_earth(moods.lat, moods.lng);
SELECT moods._id, earth_distance(ll_to_earth(moods.lat, moods.lng), ll_to_earth(40.059286,116.418773))   
AS dis FROM moods   
ORDER BY dis ASC; 

insert into users (data) values('{"name": "admin", "type": 0, "password": "admin"}'::jsonb);

insert into users (data) values('{"name": "abc", "type": 1, "password": "123"}'::jsonb);

update users set data = jsonb_set(data,'{password}','"a6b1908f3ae02557b073f4981d3f23ab5af5288577c83fd543f47ba4d0807708be0ee8e418c313a9d08cdcdb8340f22e0317408fb1857ebe04875e2ec1b48226"'::jsonb,true) where _id = 1;

update users set data = jsonb_set(data,'{password}','"add41783cf77888109ffa53cefcff16c436bdccce7afc2c9bc7a04c15bf598b4a9113f297e4321c0603dfdcf2c6349bbd38b5ed6c5ecc8ae85cd60939f34b6be"'::jsonb,true) where _id = 2;


＃生成私钥key文件

cert.crt  csr.pem key.pem

＃通过私钥文件生成CSR证书签名

openssl genrsa 1024 > key.pem
openssl req -new -key key.pem -out csr.pem
openssl x509 -req -days 365 -in csr.pem -signkey key.pem -out cert.crt

＃通过私钥文件和CSR证书签名生成证书文件
openssl x509 -req -days 365 -in csr.pem -signkey key.pem -out cert.crt

字符串	Bifang-tech!##@2017
16位 小写	12e4f29929b3a3b4
16位 大写	12E4F29929B3A3B4
32位 小写	cc302a0112e4f29929b3a3b4e62a1b9f
32位 大写	CC302A0112E4F29929B3A3B4E62A1B9F

grep 61664333 -r ./ | awk '{print $1}' | awk -F ':' '{print $1}'
56


/////////////==================================/////////////==================================
/**
 * Created by Layman(http://github.com/anysome) on 16/11/24.
 */
import React from 'react';
import {RefreshControl, InteractionManager, View, Text, Alert} from 'react-native';

import SwipeableListView from 'SwipeableListView';
import SwipeableQuickActions from 'SwipeableQuickActions';
import SwipeableQuickActionButton from 'SwipeableQuickActionButton';
import TouchableBounce from 'TouchableBounce';
import ActionSheet from '@yfuks/react-native-action-sheet';
import {analytics, airloy, styles, colors, api, toast, L, hang} from '../../app';
import util from '../../libs/Util';
import ListSource from '../../logic/ListSource';
import EventTypes from '../../logic/EventTypes';
import EditProject from './EditProject';
import Project from './Project';
import EditTask from './EditTask';

export default class Listing extends React.Component {

  constructor(props) {
    super(props);
    this.listSource = null;
    this.today = props.today;
    this.state = {
      isRefreshing: true,
      dataSource: SwipeableListView.getNewDataSource()
    };
    this.rightButtonIcon = null;
  }

  componentWillMount() {
    let route = this.props.navigator.navigationContext.currentRoute;
    route.onRightButtonPress = () => {
      this.props.navigator.push({
        title: '添加',
        component: EditProject,
        passProps: {
          onUpdated: (rowData) => this.updateRow(rowData)
        }
      });
    };
    util.isAndroid() ? this.props.navigator.replacePrevious(route) : this.props.navigator.replace(route);
  }

  componentDidMount() {
    analytics.onPageStart('page_listing');
    util.isAndroid() ? InteractionManager.runAfterInteractions(() => this.reload()) : this.reload();
  }

  componentWillUnmount() {
    analytics.onPageEnd('page_listing');
  }

  async reload() {
    this.setState({
      isRefreshing: true
    });
    let result = await airloy.net.httpGet(api.project.list.focus);
    if (result.success) {
      this.listSource = new ListSource(result.info);
      this.setState({
        dataSource: this.state.dataSource.cloneWithRowsAndSections({s1:this.listSource.datas}, ['s1'], null),
        isRefreshing: false
      });
    } else {
      result.message !== 'error.request.auth' && this.setState({
        isRefreshing: false
      });
      toast(L(result.message));
    }
  }

  _toEdit(rowData) {
    this.state.dataSource.setOpenRowID(null);
    this.props.navigator.push({
      title: '修改',
      component: EditProject,
      passProps: {
        data: rowData,
        onUpdated: (rowData) => this.updateRow(rowData)
      }
    });
  }

  _moreActions(rowData) {
    let BUTTONS = ['修改', '删除 ?', '取消'];
    ActionSheet.showActionSheetWithOptions({
        options: BUTTONS,
        cancelButtonIndex: 2,
        destructiveButtonIndex: 1,
        tintColor: colors.dark2
      },
      async(buttonIndex) => {
        switch (buttonIndex) {
          case 0:
            this._toEdit(rowData);
            break;
          case 1:
            this._toDelete(rowData);
            break;
          default:
            console.log('cancel options');
        }
      }
    );
  }

  _toDelete(rowData) {
    Alert.alert(
      '确认删除 ?',
      rowData.subTodo > 0 ? '未完成的任务可在回收站里找到.' : '彻底删除了哦!',
      [
        {text: '不了'},
        {
          text: '删除',
          onPress: async () => {
            hang();
            let result = await airloy.net.httpGet(api.project.remove, {id: rowData.id});
            if (result.success) {
              rowData.subTodo && airloy.event.emit(EventTypes.choreChange);
              this.deleteRow(rowData);
            } else {
              toast(L(result.message));
            }
            hang(false);
          }
        }
      ]
    );
  }

  _addTask(rowData) {
    this.props.navigator.push({
      title: '添加子任务',
      component: EditTask,
      passProps: {
        projectId: rowData.id,
        editable: true,
        onUpdated: (task) => {
          rowData.subTodo = rowData.subTodo + 1;
          rowData.subTotal = rowData.subTotal + 1;
          this.listSource.update(util.clone(rowData));
          this.setState({
            dataSource: this.state.dataSource.cloneWithRowsAndSections({s1:this.listSource.datas}, ['s1'], null)
          });
        }
      }
    });
  }

  _pressRow(rowData, sectionId) {
    this.props.navigator.push({
      title: rowData.title,
      component: Project,
      rightButtonIcon: require('../../../resources/icons/create.png'),
      passProps: {
        data: rowData,
        today: this.today,
        onUpdated: (rowData) => this.updateRow(rowData)
      }
    });
  }

  updateRow(rowData) {
    // also for add
    this.listSource.update(rowData);
    this.setState({
      dataSource: this.state.dataSource.cloneWithRowsAndSections({s1:this.listSource.datas}, ['s1'], null)
    });
  }

  deleteRow(rowData) {
    this.listSource.remove(rowData);
    this.setState({
      dataSource: this.state.dataSource.cloneWithRowsAndSections({s1:this.listSource.datas}, ['s1'], null)
    });
  }

  _renderRow(rowData, sectionId, rowId) {
    return (
      <TouchableBounce style={styles.listRow}
                       onPress={() => this._pressRow(rowData, sectionId)}>
        <Text style={styles.title}>{rowData.title}</Text>
        <Text style={styles.hint}>{rowData.subTodo} / {rowData.subTotal}</Text>
      </TouchableBounce>
    );
  }

  _renderSeparator(sectionId, rowId, adjacentRowHighlighted) {
    return <View key={rowId + '_separator'} style={styles.hr}></View>
  }

  _renderActions(rowData, sectionId) {
    return (
      <SwipeableQuickActions style={styles.rowActions}>
        <SwipeableQuickActionButton imageSource={{}} text={"更多"}
                                    onPress={() => this._moreActions(rowData)}
                                    style={styles.rowAction} textStyle={styles.rowText}/>
        <SwipeableQuickActionButton imageSource={{}} text={"+任务"}
                                    onPress={() => this._addTask(rowData)}
                                    style={styles.rowActionConstructive} textStyle={styles.rowText}/>
      </SwipeableQuickActions>
    );
  }

  render() {
    return (
      <SwipeableListView
        maxSwipeDistance={130}
        renderQuickActions={(rowData, sectionId, rowId) => this._renderActions(rowData, sectionId)}
        enableEmptySections={true}
        initialListSize={10}
        pageSize={5}
        dataSource={this.state.dataSource}
        renderRow={(rowData, sectionId, rowId) => this._renderRow(rowData, sectionId, rowId)}
        renderSeparator={this._renderSeparator}
        refreshControl={
                          <RefreshControl
                            refreshing={this.state.isRefreshing}
                            onRefresh={() => this.reload()}
                            tintColor={colors.accent}
                            title={'加载中...'}
                            colors={[colors.accent, colors.action]}
                            progressBackgroundColor={colors.bright1}
                          />}
      />
    );
  }
}

/////////////==================================/////////////==================================

import React, {Component} from 'react'
import {
    View, Text, StyleSheet, Image, Dimensions, Button,
    TextInput, Navigator, Alert, ActivityIndicator,
    TouchableOpacity, ListView,

} from 'react-native'

import SwipeableListView from 'SwipeableListView'
import SwipeableListViewDataSource from 'SwipeableListViewDataSource'
import SwipeableQuickActions from 'SwipeableQuickActions'
import SwipeableQuickActionButton from 'SwipeableQuickActionButton'
import Icon from 'react-native-vector-icons/Ionicons'

import config from '../../config'
import i18n from '../../asserts/langs'
import ajax from '../../common/ajax'
import NavBar from '../navbar'

var {height, width} = Dimensions.get('window')

export default class TodayMoodsComponent extends Component {
    constructor(props){
        super(props)
        var ds_0 = new ListView.DataSource({rowHasChanged: (r1, r2) => r1 !== r2})
        var ds = new SwipeableListViewDataSource({
            getRowData: (dataBlob, sectionId, rowId) => dataBlob[sectionId][(rowId)],
            rowHasChanged: (row1, row2) => row1 !== row2,
            sectionHeaderHasChanged: (s1, s2) => s1 !== s2
        })

        this.state = {
            dataSource: ds.cloneWithRowsAndSections({s1: ds_0.cloneWithRows([
                {
                    id: 0, moodTitle: 'Mood1, Happy!', moodTime: '22:35',
                    moodSummary: 'This is a sunny day today!', moodFlag: true
                },
                {
                    id: 1, moodTitle: 'Mood2, Happy!', moodTime: '21:30',
                    moodSummary: 'This is a sunny day today!', moodFlag: false
                },
                {
                    id: 2, moodTitle: 'Mood3, Happy!', moodTime: '20:25',
                    moodSummary: 'This is a sunny day today!', moodFlag: true
                },
                {
                    id: 3, moodTitle: 'Mood4, Happy!', moodTime: '19:10',
                    moodSummary: 'This is a sunny day today!', moodFlag: false
                },
                {
                    id: 4, moodTitle: 'Mood5, Happy!', moodTime: '18:05',
                    moodSummary: 'This is a sunny day today!', moodFlag: true
                },
                {
                    id: 5, moodTitle: 'Mood6, Happy!', moodTime: '17:50',
                    moodSummary: 'This is a sunny day today!', moodFlag: true
                },
            ])}, ['s1','s1','s1','s1','s1','s1'], ['0', '1', '2', '3', '4', '5']),

            isInProgressing: false,
        }
    }

    render(){
        return (
            <View style={styles.container}>
                <NavBar route={this.props.route} navigator={this.props.navigator}/>
                <View style={styles.content}>
                    <TouchableOpacity
                        activeOpacity={1}
                        style={styles.searchBar}>
                        <View style={styles.searchbarCenter}>
                            <Icon name={'ios-search'} size={16}  style={{color: '#999999'}}>
                                {'  ' + i18n('search')}
                            </Icon>
                        </View>
                        <Icon name={'ios-mic'} size={20}  style={{width: 16, color: '#999999',
                        }} />
                    </TouchableOpacity>
                    <View style={styles.listView}>
                        {
                            true ?
                                <SwipeableListView
                                    dataSource={this.state.dataSource}
                                    renderRow={this._renderRow.bind(this)}
                                    maxSwipeDistance={120}
                                    renderQuickActions={
                                        (rowData, sectionId, rowId) => this._renderActions(rowData, sectionId)
                                    }
                                    enableEmptySections={true}
                                    initialListSize={10}
                                    pageSize={10}/>

                                :
                                <ListView dataSource={this.state.dataSource}
                                          renderRow={this._renderRow.bind(this)}/>
                        }
                    </View>
                </View>
            </View>
        )
    }

    _renderRow(rowData){
        return (
            <View style={styles.rowContainer}>
                <Image style={[styles.moodImage, {backgroundColor: moodImgColors[rowData.id]}]}/>
                <View style={styles.moodItemContent}>
                    <View style={styles.moodTitleAndTime}>
                        <Text style={styles.moodTitle}>
                            {rowData.moodTitle}
                        </Text>
                        <Text style={styles.moodTime}>
                            {rowData.moodTime}
                        </Text>
                    </View>

                    <View style={styles.moodSummaryAndFlag}>
                        <Text style={styles.moodSummary}>{rowData.moodSummary}</Text>
                        <Icon style={styles.moodFlag} size={18}
                              color={'#3ac17e'}
                              name={ rowData.moodFlag ? 'ios-checkmark-circle' : 'ios-checkmark-circle-outline'}></Icon>
                    </View>
                </View>
            </View>
        )
    }

    _renderActions(rowData, sectionId) {
        return (
            <SwipeableQuickActions style={styles.rowActions}>
                { sectionId !== 2 &&
                <SwipeableQuickActionButton imageSource={{}} text={"更多"}
                                            onPress={() => this._moreActions(rowData, sectionId)}
                                            style={styles.rowAction} textStyle={styles.rowText}/>
                }
                <SwipeableQuickActionButton imageSource={{}} text={"删除"}
                                            onPress={() => this._delete(rowData)}
                                            style={styles.rowActionDestructive} textStyle={styles.rowText}/>
            </SwipeableQuickActions>
        );
    }
}

const moodImgColors = ['#fd6461', '#f7a650', '#f4cd56', '#71ca58', '#51baf2', '#d08ce0']

const styles = StyleSheet.create({
    container:{
        flex: 1,
        backgroundColor: '#fff',
    },
    content:{
        flex: 1,
        backgroundColor: '#ebedee'

    },
    searchBar: {
        height: 30,
        borderRadius: 4,
        marginLeft: 10,
        marginTop: 10,
        marginRight: 10,
        marginBottom: 10,
        flexDirection: 'row',
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: '#fff',
    },
    searchbarCenter: {
        flex: 1,
        flexDirection: 'row',
        justifyContent: 'center',
        alignItems: 'center',
        marginLeft: 8,
    },
    rowContainer: {
        height: 64,
        backgroundColor: '#fff',
        borderBottomWidth: 1,
        borderBottomColor: '#efefef',
        flexDirection: 'row',
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: '#fff',
    },
    moodImage: {
        marginLeft: 10,
        width: 48,
        height: 48,
        borderRadius: 24,
    },
    moodItemContent: {
        flex: 1,
        marginLeft: 16,
        justifyContent: 'center',
        alignItems: 'center',
    },
    moodTitleAndTime: {
        flex: 1,
        flexDirection: 'row',
        width: width - 64 - 26,
        justifyContent: 'space-between',
        alignItems: 'center',
    },
    moodSummaryAndFlag: {
        flex: 1,
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        width: width - 64 - 26,
    },
    moodTitle: {
        fontSize: 16,
    },
    moodTime: {
        fontSize: 12,
        color: '#aaaaaa',
    },
    moodSummary: {
        fontSize: 14,
        color: '#aaaaaa',
    }

})

